// Generated by HLC 4.1.5 (HL v5)
#define HLC_BOOT
#include <hlc.h>
#include <components/managers/Simulation.h>
#include <components/managers/Riders.h>
#include <_std/Main.h>
#include <components/stage/LRConsole.h>
#include <components/managers/Musicplayer.h>
extern $Main g$_Main;
extern String s$No_riders_in_current_track;
extern hl_type t$_i32;
#include <h2d/Console.h>
void h2d_Console_log(h2d__Console,String,vdynamic*);
void components_managers_Simulation_restoreFlagPoint(components__managers__Simulation);
void components_managers_Simulation_restoreState(components__managers__Simulation,int);
void components_managers_Musicplayer_stopMusic(components__managers__Musicplayer);
void components_managers_Musicplayer_playMusic(components__managers__Musicplayer,int);
double components_managers_Simulation_get_desiredSimSpeed(components__managers__Simulation);
void components_managers_Simulation_stepSim(components__managers__Simulation);
void components_managers_Riders_stepRiders(components__managers__Riders);
void components_managers_Simulation_recordGlobalSimState(components__managers__Simulation);
#include <haxe/ds/StringMap.h>
#include <components/sledder/RiderBase.h>
#include <hl/types/ArrayObj.h>
#include <components/physics/RidePoint.h>
#include <h2d/col/Point.h>
double Math_max(double,double);
vvirtual* haxe_ds_StringMap_iterator(haxe__ds__StringMap);
extern hl_type t$vrt_91f9e97;
extern hl_type t$fun_bf7849e;
extern hl_type t$fun_6c7a217;
vdynamic* haxe_ds_ObjectMap_get(haxe__ds__ObjectMap,vdynamic*);
extern hl_type t$hl_types_ArrayObj;
extern hl_type t$_dyn;
extern hl_type t$vrt_6e00ada;
void components_managers_Simulation_recordRiderState(components__managers__Simulation,components__sledder__RiderBase,int);
extern hl_type t$_bool;
extern hl_type t$vrt_6c2da0f;
void components_physics_RidePoint_restoreState(components__physics__RidePoint,vvirtual*);
extern hl_type t$vrt_b840ca7;
void hl_types_ArrayObj_new(hl__types__ArrayObj);
extern hl_type t$haxe_ds_ObjectMap;
void haxe_ds_ObjectMap_set(haxe__ds__ObjectMap,vdynamic*,vdynamic*);
void hl_types_ArrayObj___expand(hl__types__ArrayObj,int);
vvirtual* components_physics_RidePoint_saveState(components__physics__RidePoint);
int hl_types_ArrayObj_push(hl__types__ArrayObj,vdynamic*);
void haxe_ds_ObjectMap_new(haxe__ds__ObjectMap);

void components_managers_Simulation_startSim(components__managers__Simulation r0) {
	String r7;
	components__managers__Riders r3;
	haxe__ds__ObjectMap r11;
	bool r9;
	components__managers__Musicplayer r12;
	$Main r4;
	double r10;
	vdynamic *r8;
	components__stage__LRConsole r6;
	int r2, r5;
	r4 = ($Main)g$_Main;
	r3 = r4->riders;
	if( r3 == NULL ) hl_null_access();
	r2 = r3->riderCount;
	r5 = 0;
	if( r2 != r5 ) goto label$d8284df_1_14;
	r4 = ($Main)g$_Main;
	r6 = r4->console;
	if( r6 == NULL ) hl_null_access();
	r7 = (String)s$No_riders_in_current_track;
	r2 = 16711680;
	r8 = hl_alloc_dynamic(&t$_i32);
	r8->v.i = r2;
	h2d_Console_log(((h2d__Console)r6),r7,r8);
	return;
	label$d8284df_1_14:
	r9 = true;
	r0->playing = r9;
	r9 = false;
	r0->paused = r9;
	r10 = 0.;
	r0->timeDelta = r10;
	r11 = r0->flagPoint;
	if( !r11 ) goto label$d8284df_1_24;
	components_managers_Simulation_restoreFlagPoint(r0);
	goto label$d8284df_1_26;
	label$d8284df_1_24:
	r2 = 0;
	components_managers_Simulation_restoreState(r0,r2);
	label$d8284df_1_26:
	r4 = ($Main)g$_Main;
	r12 = r4->audio;
	if( r12 == NULL ) hl_null_access();
	components_managers_Musicplayer_stopMusic(r12);
	r4 = ($Main)g$_Main;
	r12 = r4->audio;
	if( r12 == NULL ) hl_null_access();
	r2 = r0->frames;
	components_managers_Musicplayer_playMusic(r12,r2);
	return;
}

void components_managers_Simulation_pauseSim(components__managers__Simulation r0) {
	bool r2;
	components__managers__Musicplayer r3;
	$Main r4;
	r2 = r0->playing;
	if( r2 ) goto label$d8284df_2_6;
	r2 = r0->paused;
	if( r2 ) goto label$d8284df_2_6;
	components_managers_Simulation_startSim(r0);
	return;
	label$d8284df_2_6:
	r4 = ($Main)g$_Main;
	r3 = r4->audio;
	if( r3 == NULL ) hl_null_access();
	components_managers_Musicplayer_stopMusic(r3);
	r2 = false;
	r0->playing = r2;
	r2 = true;
	r0->paused = r2;
	return;
}

void components_managers_Simulation_resumeSim(components__managers__Simulation r0) {
	bool r1;
	components__managers__Musicplayer r3;
	$Main r4;
	int r5;
	r1 = true;
	r0->playing = r1;
	r1 = false;
	r0->paused = r1;
	r4 = ($Main)g$_Main;
	r3 = r4->audio;
	if( r3 == NULL ) hl_null_access();
	r5 = r0->frames;
	components_managers_Musicplayer_playMusic(r3,r5);
	return;
}

void components_managers_Simulation_endSim(components__managers__Simulation r0) {
	haxe__ds__ObjectMap r4;
	bool r1;
	components__managers__Musicplayer r6;
	$Main r7;
	double r2;
	int r5;
	r1 = false;
	r0->playing = r1;
	r1 = false;
	r0->paused = r1;
	r2 = 0.;
	r0->timeDelta = r2;
	r4 = r0->flagPoint;
	if( !r4 ) goto label$d8284df_4_10;
	components_managers_Simulation_restoreFlagPoint(r0);
	goto label$d8284df_4_12;
	label$d8284df_4_10:
	r5 = 0;
	components_managers_Simulation_restoreState(r0,r5);
	label$d8284df_4_12:
	r7 = ($Main)g$_Main;
	r6 = r7->audio;
	if( r6 == NULL ) hl_null_access();
	components_managers_Musicplayer_stopMusic(r6);
	return;
}

void components_managers_Simulation_playSim(components__managers__Simulation r0,double r1) {
	double r2, r3;
	r2 = r0->timeDelta;
	r2 = r2 + r1;
	r0->timeDelta = r2;
	label$d8284df_5_3:
	r2 = r0->timeDelta;
	r3 = components_managers_Simulation_get_desiredSimSpeed(r0);
	if( !(r2 >= r3) ) goto label$d8284df_5_13;
	components_managers_Simulation_stepSim(r0);
	r2 = r0->timeDelta;
	r3 = components_managers_Simulation_get_desiredSimSpeed(r0);
	r2 = r2 - r3;
	r0->timeDelta = r2;
	goto label$d8284df_5_3;
	label$d8284df_5_13:
	return;
}

void components_managers_Simulation_rewindSim(components__managers__Simulation r0,double r1) {
	double r2, r3;
	int r5, r6;
	r2 = r0->timeDelta;
	r2 = r2 + r1;
	r0->timeDelta = r2;
	label$d8284df_6_3:
	r2 = r0->timeDelta;
	r3 = components_managers_Simulation_get_desiredSimSpeed(r0);
	if( !(r2 >= r3) ) goto label$d8284df_6_18;
	if( r0 == NULL ) hl_null_access();
	r5 = r0->frames;
	r6 = 1;
	r5 = r5 - r6;
	r0->frames = r5;
	components_managers_Simulation_restoreState(r0,r5);
	r2 = r0->timeDelta;
	r3 = components_managers_Simulation_get_desiredSimSpeed(r0);
	r2 = r2 - r3;
	r0->timeDelta = r2;
	goto label$d8284df_6_3;
	label$d8284df_6_18:
	return;
}

void components_managers_Simulation_stepSim(components__managers__Simulation r0) {
	components__managers__Riders r3;
	$Main r4;
	int r1;
	r1 = r0->frames;
	++r1;
	r0->frames = r1;
	r4 = ($Main)g$_Main;
	r3 = r4->riders;
	if( r3 == NULL ) hl_null_access();
	components_managers_Riders_stepRiders(r3);
	components_managers_Simulation_recordGlobalSimState(r0);
	return;
}

void components_managers_Simulation_backSim(components__managers__Simulation r0) {
	int r2, r3;
	if( r0 == NULL ) hl_null_access();
	r2 = r0->frames;
	r3 = 1;
	r2 = r2 - r3;
	r0->frames = r2;
	components_managers_Simulation_restoreState(r0,r2);
	return;
}

void components_managers_Simulation_restoreState(components__managers__Simulation r0,int r1) {
	components__managers__Riders r9;
	haxe__ds__ObjectMap r15;
	hl__types__ArrayObj r16;
	haxe__ds__StringMap r8;
	vvirtual *r7, *r12, *r18, *r23;
	bool r13;
	components__sledder__RiderBase r14;
	$Main r10;
	components__physics__RidePoint r22;
	double r2, r4;
	vdynamic *r11;
	varray *r19;
	int r3, r6, r17, r20, r21;
	r2 = (double)r1;
	r4 = 0.;
	r2 = Math_max(r2,r4);
	r3 = (int)r2;
	r0->frames = r3;
	r10 = ($Main)g$_Main;
	r9 = r10->riders;
	if( r9 == NULL ) hl_null_access();
	r8 = r9->riders;
	if( r8 == NULL ) hl_null_access();
	r7 = haxe_ds_StringMap_iterator(r8);
	r12 = hl_to_virtual(&t$vrt_91f9e97,(vdynamic*)r7);
	label$d8284df_9_12:
	if( r12 == NULL ) hl_null_access();
	if( hl_vfields(r12)[0] ) r13 = ((bool (*)(vdynamic*))hl_vfields(r12)[0])(r12->value); else {
		vdynamic ret;
		hl_dyn_call_obj(r12->value,&t$fun_bf7849e,407283053/*hasNext*/,NULL,&ret);
		r13 = (bool)ret.v.i;
	}
	if( !r13 ) goto label$d8284df_9_69;
	if( hl_vfields(r12)[1] ) r14 = ((components__sledder__RiderBase (*)(vdynamic*))hl_vfields(r12)[1])(r12->value); else {
		r14 = (components__sledder__RiderBase)hl_dyn_call_obj(r12->value,&t$fun_6c7a217,151160317/*next*/,NULL,NULL);
	}
	r15 = r0->frameStates;
	if( r15 == NULL ) hl_null_access();
	r11 = haxe_ds_ObjectMap_get(r15,((vdynamic*)r14));
	r16 = (hl__types__ArrayObj)hl_dyn_castp(&r11,&t$_dyn,&t$hl_types_ArrayObj);
	if( r16 == NULL ) hl_null_access();
	r17 = r16->length;
	if( ((unsigned)r3) < ((unsigned)r17) ) goto label$d8284df_9_26;
	r18 = NULL;
	goto label$d8284df_9_29;
	label$d8284df_9_26:
	r19 = r16->array;
	r11 = ((vdynamic**)(r19 + 1))[r3];
	r18 = hl_to_virtual(&t$vrt_6e00ada,(vdynamic*)r11);
	label$d8284df_9_29:
	if( r18 ) goto label$d8284df_9_33;
	r6 = r0->frames;
	components_managers_Simulation_recordRiderState(r0,r14,r6);
	goto label$d8284df_9_12;
	label$d8284df_9_33:
	if( r14 == NULL ) hl_null_access();
	if( r18 == NULL ) hl_null_access();
	r13 = hl_vfields(r18)[0] ? (*(bool*)(hl_vfields(r18)[0])) : (bool)hl_dyn_geti(r18->value,-273866879/*crashed*/,&t$_bool);
	r14->crashed = r13;
	r6 = 0;
	r16 = r14->ridePoints;
	if( r16 == NULL ) hl_null_access();
	r17 = r16->length;
	label$d8284df_9_41:
	if( r6 >= r17 ) goto label$d8284df_9_68;
	r20 = r6;
	++r6;
	if( r14 == NULL ) hl_null_access();
	r16 = r14->ridePoints;
	if( r16 == NULL ) hl_null_access();
	r21 = r16->length;
	if( ((unsigned)r20) < ((unsigned)r21) ) goto label$d8284df_9_52;
	r22 = NULL;
	goto label$d8284df_9_55;
	label$d8284df_9_52:
	r19 = r16->array;
	r11 = ((vdynamic**)(r19 + 1))[r20];
	r22 = (components__physics__RidePoint)r11;
	label$d8284df_9_55:
	if( r22 == NULL ) hl_null_access();
	if( r18 == NULL ) hl_null_access();
	r16 = hl_vfields(r18)[1] ? (*(hl__types__ArrayObj*)(hl_vfields(r18)[1])) : (hl__types__ArrayObj)hl_dyn_getp(r18->value,-147975645/*points*/,&t$hl_types_ArrayObj);
	if( r16 == NULL ) hl_null_access();
	r21 = r16->length;
	if( ((unsigned)r20) < ((unsigned)r21) ) goto label$d8284df_9_63;
	r23 = NULL;
	goto label$d8284df_9_66;
	label$d8284df_9_63:
	r19 = r16->array;
	r11 = ((vdynamic**)(r19 + 1))[r20];
	r23 = hl_to_virtual(&t$vrt_6c2da0f,(vdynamic*)r11);
	label$d8284df_9_66:
	components_physics_RidePoint_restoreState(r22,r23);
	goto label$d8284df_9_41;
	label$d8284df_9_68:
	goto label$d8284df_9_12;
	label$d8284df_9_69:
	return;
}

void components_managers_Simulation_restoreFlagPoint(components__managers__Simulation r0) {
	return;
}

void components_managers_Simulation_recordGlobalSimState(components__managers__Simulation r0) {
	components__managers__Riders r3;
	haxe__ds__StringMap r2;
	vvirtual *r1, *r5;
	bool r7;
	components__sledder__RiderBase r8;
	$Main r4;
	int r9;
	r4 = ($Main)g$_Main;
	r3 = r4->riders;
	if( r3 == NULL ) hl_null_access();
	r2 = r3->riders;
	if( r2 == NULL ) hl_null_access();
	r1 = haxe_ds_StringMap_iterator(r2);
	r5 = hl_to_virtual(&t$vrt_91f9e97,(vdynamic*)r1);
	label$d8284df_11_7:
	if( r5 == NULL ) hl_null_access();
	if( hl_vfields(r5)[0] ) r7 = ((bool (*)(vdynamic*))hl_vfields(r5)[0])(r5->value); else {
		vdynamic ret;
		hl_dyn_call_obj(r5->value,&t$fun_bf7849e,407283053/*hasNext*/,NULL,&ret);
		r7 = (bool)ret.v.i;
	}
	if( !r7 ) goto label$d8284df_11_15;
	if( hl_vfields(r5)[1] ) r8 = ((components__sledder__RiderBase (*)(vdynamic*))hl_vfields(r5)[1])(r5->value); else {
		r8 = (components__sledder__RiderBase)hl_dyn_call_obj(r5->value,&t$fun_6c7a217,151160317/*next*/,NULL,NULL);
	}
	r9 = r0->frames;
	components_managers_Simulation_recordRiderState(r0,r8,r9);
	goto label$d8284df_11_7;
	label$d8284df_11_15:
	return;
}

void components_managers_Simulation_recordRiderState(components__managers__Simulation r0,components__sledder__RiderBase r1,int r2) {
	haxe__ds__ObjectMap r5;
	vvirtual *r7, *r9, *r12, *r17;
	hl__types__ArrayObj r6, r8;
	bool r10;
	components__physics__RidePoint r16;
	vdynamic *r4;
	varray *r14;
	int r11, r13, r15;
	r5 = r0->frameStates;
	if( r5 == NULL ) hl_null_access();
	r4 = haxe_ds_ObjectMap_get(r5,((vdynamic*)r1));
	r6 = (hl__types__ArrayObj)hl_dyn_castp(&r4,&t$_dyn,&t$hl_types_ArrayObj);
	if( r6 ) goto label$d8284df_12_18;
	r5 = r0->frameStates;
	if( r5 ) goto label$d8284df_12_9;
	r7 = NULL;
	goto label$d8284df_12_13;
	label$d8284df_12_9:
	r7 = r5->f$1;
	if( r7 ) goto label$d8284df_12_13;
	r7 = hl_to_virtual(&t$vrt_b840ca7,(vdynamic*)r5);
	r5->f$1 = r7;
	label$d8284df_12_13:
	r6 = (hl__types__ArrayObj)hl_alloc_obj(&t$hl_types_ArrayObj);
	hl_types_ArrayObj_new(r6);
	r5 = (haxe__ds__ObjectMap)hl_dyn_castp(&r7,&t$vrt_b840ca7,&t$haxe_ds_ObjectMap);
	if( r5 == NULL ) hl_null_access();
	haxe_ds_ObjectMap_set(r5,((vdynamic*)r1),((vdynamic*)r6));
	label$d8284df_12_18:
	r9 = hl_alloc_virtual(&t$vrt_6e00ada);
	if( r1 == NULL ) hl_null_access();
	r10 = r1->crashed;
	if( hl_vfields(r9)[0] ) *(bool*)(hl_vfields(r9)[0]) = (bool)r10; else hl_dyn_seti(r9->value,-273866879/*crashed*/,&t$_bool,r10);
	r6 = (hl__types__ArrayObj)hl_alloc_obj(&t$hl_types_ArrayObj);
	hl_types_ArrayObj_new(r6);
	if( hl_vfields(r9)[1] ) *(hl__types__ArrayObj*)(hl_vfields(r9)[1]) = (hl__types__ArrayObj)r6; else hl_dyn_setp(r9->value,-147975645/*points*/,&t$hl_types_ArrayObj,r6);
	r5 = r0->frameStates;
	if( r5 == NULL ) hl_null_access();
	r4 = haxe_ds_ObjectMap_get(r5,((vdynamic*)r1));
	r6 = (hl__types__ArrayObj)hl_dyn_castp(&r4,&t$_dyn,&t$hl_types_ArrayObj);
	if( r6 == NULL ) hl_null_access();
	r13 = r6->length;
	if( ((unsigned)r2) < ((unsigned)r13) ) goto label$d8284df_12_33;
	hl_types_ArrayObj___expand(r6,r2);
	label$d8284df_12_33:
	r14 = r6->array;
	((vvirtual**)(r14 + 1))[r2] = r9;
	r6 = (hl__types__ArrayObj)hl_alloc_obj(&t$hl_types_ArrayObj);
	hl_types_ArrayObj_new(r6);
	r11 = 0;
	r8 = r1->ridePoints;
	label$d8284df_12_39:
	if( r8 == NULL ) hl_null_access();
	r15 = r8->length;
	if( r11 >= r15 ) goto label$d8284df_12_56;
	r15 = r8->length;
	if( ((unsigned)r11) < ((unsigned)r15) ) goto label$d8284df_12_47;
	r16 = NULL;
	goto label$d8284df_12_50;
	label$d8284df_12_47:
	r14 = r8->array;
	r4 = ((vdynamic**)(r14 + 1))[r11];
	r16 = (components__physics__RidePoint)r4;
	label$d8284df_12_50:
	++r11;
	if( r6 == NULL ) hl_null_access();
	if( r16 == NULL ) hl_null_access();
	r17 = components_physics_RidePoint_saveState(r16);
	r13 = hl_types_ArrayObj_push(r6,((vdynamic*)r17));
	goto label$d8284df_12_39;
	label$d8284df_12_56:
	r5 = r0->frameStates;
	if( r5 == NULL ) hl_null_access();
	r4 = haxe_ds_ObjectMap_get(r5,((vdynamic*)r1));
	r8 = (hl__types__ArrayObj)hl_dyn_castp(&r4,&t$_dyn,&t$hl_types_ArrayObj);
	if( r8 == NULL ) hl_null_access();
	r13 = r8->length;
	if( ((unsigned)r2) < ((unsigned)r13) ) goto label$d8284df_12_65;
	r12 = NULL;
	goto label$d8284df_12_68;
	label$d8284df_12_65:
	r14 = r8->array;
	r4 = ((vdynamic**)(r14 + 1))[r2];
	r12 = hl_to_virtual(&t$vrt_6e00ada,(vdynamic*)r4);
	label$d8284df_12_68:
	if( r12 == NULL ) hl_null_access();
	if( hl_vfields(r12)[1] ) *(hl__types__ArrayObj*)(hl_vfields(r12)[1]) = (hl__types__ArrayObj)r6; else hl_dyn_setp(r12->value,-147975645/*points*/,&t$hl_types_ArrayObj,r6);
	return;
}

void components_managers_Simulation_updateSimHistory(components__managers__Simulation r0,int r1) {
	return;
}

void components_managers_Simulation_updateSim(components__managers__Simulation r0) {
	bool r5;
	int r1, r3, r4;
	r1 = 0;
	label$d8284df_14_1:
	r3 = 40;
	if( r1 >= r3 ) goto label$d8284df_14_17;
	++r1;
	components_managers_Simulation_stepSim(r0);
	r3 = r0->frames;
	r4 = r0->returnPoint;
	if( r3 < r4 ) goto label$d8284df_14_16;
	r5 = false;
	r0->updating = r5;
	r3 = r0->rewindPoint;
	r0->frames = r3;
	r3 = r0->rewindPoint;
	components_managers_Simulation_restoreState(r0,r3);
	return;
	label$d8284df_14_16:
	goto label$d8284df_14_1;
	label$d8284df_14_17:
	return;
}

double components_managers_Simulation_get_desiredSimSpeed(components__managers__Simulation r0) {
	double r1;
	r1 = r0->desiredSimSpeed;
	return r1;
}

double components_managers_Simulation_set_desiredSimSpeed(components__managers__Simulation r0,double r1) {
	double r2;
	r2 = 1.;
	r2 = r2 / r1;
	r0->desiredSimSpeed = r2;
	return r2;
}

void components_managers_Simulation_new(components__managers__Simulation r0) {
	haxe__ds__ObjectMap r4;
	bool r3;
	double r2;
	int r1;
	r1 = 0;
	r0->returnPoint = r1;
	r1 = 0;
	r0->rewindPoint = r1;
	r2 = 0.;
	r0->timeDelta = r2;
	r3 = false;
	r0->updating = r3;
	r3 = false;
	r0->rewinding = r3;
	r3 = false;
	r0->paused = r3;
	r3 = false;
	r0->playing = r3;
	r1 = 0;
	r0->frames = r1;
	r4 = (haxe__ds__ObjectMap)hl_alloc_obj(&t$haxe_ds_ObjectMap);
	haxe_ds_ObjectMap_new(r4);
	r0->frameStates = r4;
	r2 = 40.;
	r2 = components_managers_Simulation_set_desiredSimSpeed(r0,r2);
	components_managers_Simulation_recordGlobalSimState(r0);
	r1 = 0;
	components_managers_Simulation_restoreState(r0,r1);
	return;
}

